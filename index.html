<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Endless Tower Climb</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Courier New', monospace; background: #1a1a2e; color: #eee; }
        #gameContainer { max-width: 1400px; margin: 0 auto; padding: 20px; }
        #gameTitle { text-align: center; font-size: 2.5em; color: #ffd700; margin-bottom: 20px; }
        .game-area { display: grid; grid-template-columns: 280px 1fr 320px; gap: 20px; }
        .panel { background: #16213e; border: 3px solid #0f3460; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .panel h2 { color: #ffd700; border-bottom: 2px solid #0f3460; padding-bottom: 8px; margin-bottom: 15px; }
        .stat-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #0f3460; }
        .progress-bar { width: 100%; height: 20px; background: #0f3460; border-radius: 10px; margin: 5px 0; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.3s; text-align: center; color: #fff; line-height: 20px; font-size: 0.8em; }
        .hp-fill { background: #ff4b2b; }
        .xp-fill { background: #ffd700; }
        #battleArea { background: #0f3460; border-radius: 8px; padding: 20px; position: relative; min-height: 300px; }
        .character-sprite, .enemy-sprite { position: absolute; font-size: 4em; }
        .character-sprite { bottom: 30px; left: 50px; }
        .enemy-sprite { bottom: 30px; right: 50px; }
        .btn { padding: 12px 20px; background: #667eea; border: none; border-radius: 5px; color: white; font-weight: bold; cursor: pointer; margin: 5px; transition: all 0.3s; }
        .btn:hover { background: #764ba2; transform: translateY(-2px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        #classSelection { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; padding: 20px; }
        .class-card { background: #16213e; border: 3px solid #0f3460; border-radius: 8px; padding: 20px; cursor: pointer; text-align: center; transition: all 0.3s; }
        .class-card:hover { border-color: #ffd700; transform: translateY(-5px); }
        .class-icon { font-size: 3em; margin-bottom: 10px; }
        .item-slot { background: #0f3460; border: 2px solid #1a1a2e; border-radius: 5px; padding: 10px; margin: 5px 0; cursor: pointer; }
        .item-slot:hover { border-color: #ffd700; }
        #eventLog { background: #0f3460; border-radius: 8px; padding: 15px; height: 150px; overflow-y: auto; margin-top: 10px; font-size: 0.9em; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: #16213e; border: 3px solid #ffd700; border-radius: 8px; padding: 30px; max-width: 600px; max-height: 80vh; overflow-y: auto; }
        .rarity-common { color: #fff; }
        .rarity-uncommon { color: #00ff00; }
        .rarity-rare { color: #4169e1; }
        .rarity-epic { color: #9370db; }
        .rarity-legendary { color: #ffd700; }
        .talent-tree { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; }
        .talent-node { background: #0f3460; border: 2px solid #1a1a2e; border-radius: 8px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .talent-node:hover { border-color: #ffd700; }
        .talent-node.unlocked { border-color: #00ff00; background: #1a3a1a; }
        .talent-node.locked { opacity: 0.5; cursor: not-allowed; }
        .pet-card { background: #0f3460; border: 2px solid #1a1a2e; border-radius: 8px; padding: 15px; margin: 10px 0; display: flex; justify-content: space-between; align-items: center; }
        .pet-card.active { border-color: #00ff00; background: #1a3a1a; }
        .pet-sprite { position: absolute; bottom: 30px; left: 150px; font-size: 2em; }
    </style>
</head>
<body>
    <div id="gameContainer">
        <h1 id="gameTitle">‚öîÔ∏è ENDLESS TOWER CLIMB ‚öîÔ∏è</h1>
        
        <div id="classSelectionScreen" class="panel">
            <h2>Choose Your Class</h2>
            <div id="classSelection"></div>
        </div>

        <div id="gameArea" class="game-area" style="display: none;">
            <div>
                <div class="panel">
                    <h2>Character</h2>
                    <div class="stat-row"><span>Class:</span><span id="className"></span></div>
                    <div class="stat-row"><span>Level:</span><span id="charLevel">1</span></div>
                    <div class="stat-row"><span>Talent Points:</span><span id="talentPoints" style="color: #ffd700;">0</span></div>
                    <div class="stat-row"><span>HP:</span><span id="charHP">100/100</span></div>
                    <div class="progress-bar"><div class="progress-fill hp-fill" id="hpBar" style="width: 100%;">100%</div></div>
                    <div class="stat-row"><span>XP:</span><span id="charXP">0/100</span></div>
                    <div class="progress-bar"><div class="progress-fill xp-fill" id="xpBar" style="width: 0%;">0%</div></div>
                    <div class="stat-row"><span>Attack:</span><span id="charAttack">10</span></div>
                    <div class="stat-row"><span>Defense:</span><span id="charDefense">5</span></div>
                    <div class="stat-row"><span>Gold:</span><span id="charGold">üí∞ 0</span></div>
                    <div class="stat-row"><span>Materials:</span><span id="charMaterials">üîÆ 0</span></div>
                    <div style="margin-top: 15px;">
                        <button class="btn" onclick="game.openTalents()" style="width: 100%;">üåü Talents</button>
                        <button class="btn" onclick="game.openPets()" style="width: 100%;">üêæ Pets</button>
                        <button class="btn" onclick="game.openCheats()" style="width: 100%; background: #ff0066;">üîß Debug</button>
                        <button class="btn" onclick="game.saveGame()" style="width: 100%;">üíæ Save</button>
                        <button class="btn" onclick="game.loadGame()" style="width: 100%;">üìÇ Load</button>
                    </div>
                </div>

                <div class="panel">
                    <h2>Active Pet</h2>
                    <div id="activePet" style="text-align: center; padding: 20px; color: #aaa;">No pet active</div>
                </div>
            </div>

            <div>
                <div class="panel" style="display: flex; flex-direction: column;">
                    <div style="background: #0f3460; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                        <div>FLOOR</div>
                        <div id="floorNumber" style="font-size: 2em; color: #ffd700;">1</div>
                    </div>
                    <div id="battleArea">
                        <div class="character-sprite" id="playerSprite">üó°Ô∏è</div>
                        <div class="pet-sprite" id="petSprite"></div>
                        <div class="enemy-sprite">
                            <div id="enemySprite">üëπ</div>
                            <div style="text-align: center; font-size: 0.3em; margin-top: 10px;">
                                <div id="enemyName">Enemy</div>
                                <div id="enemyHP">HP: 100/100</div>
                            </div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px;">
                        <button class="btn" onclick="game.playerAttack()" style="background: #ff4b2b;">‚öîÔ∏è Attack</button>
                        <button class="btn" onclick="game.playerDefend()" style="background: #00f2fe;">üõ°Ô∏è Defend</button>
                        <button class="btn" onclick="game.useAbility()" style="background: #ffd700;">‚ú® Ability</button>
                        <button class="btn" onclick="game.nextFloor()" id="proceedBtn" style="display: none; grid-column: 1/-1; background: #38ef7d;">‚¨ÜÔ∏è Next Floor</button>
                        <button class="btn" onclick="game.openShop()">üè™ Shop</button>
                    </div>
                    <div id="eventLog"></div>
                </div>
            </div>

            <div>
                <div class="panel">
                    <h2>Inventory</h2>
                    <div id="inventoryGrid"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="shopModal" class="modal">
        <div class="modal-content">
            <h2>üè™ Shop</h2>
            <div id="shopItems"></div>
            <button class="btn" onclick="game.closeShop()">Close</button>
        </div>
    </div>

    <div id="talentModal" class="modal">
        <div class="modal-content">
            <h2>üåü Talent Tree</h2>
            <p>Available Points: <span id="availablePoints" style="color: #ffd700; font-weight: bold;">0</span></p>
            <div class="talent-tree" id="talentTree"></div>
            <button class="btn" onclick="game.closeTalents()">Close</button>
        </div>
    </div>

    <div id="petModal" class="modal">
        <div class="modal-content">
            <h2>üêæ Companions</h2>
            <div id="petList"></div>
            <button class="btn" onclick="game.closePets()">Close</button>
        </div>
    </div>

    <div id="cheatModal" class="modal">
        <div class="modal-content">
            <h2>üîß Debug Menu</h2>
            <div id="cheatContent">
                <div style="margin-bottom: 20px;">
                    <label>Password:</label><br>
                    <input type="password" id="cheatPassword" style="width: 100%; padding: 10px; margin-top: 5px; background: #0f3460; border: 2px solid #1a1a2e; color: #fff; border-radius: 5px;">
                    <button class="btn" onclick="game.unlockCheats()" style="width: 100%; margin-top: 10px;">Unlock</button>
                </div>
                <div id="cheatButtons" style="display: none;">
                    <h3 style="color: #ffd700; margin-bottom: 15px;">Developer Tools</h3>
                    <button class="btn" onclick="game.cheat('gold')" style="width: 100%; margin: 5px 0;">üí∞ +10000 Gold</button>
                    <button class="btn" onclick="game.cheat('xp')" style="width: 100%; margin: 5px 0;">‚≠ê +5000 XP</button>
                    <button class="btn" onclick="game.cheat('level')" style="width: 100%; margin: 5px 0;">üìà +10 Levels</button>
                    <button class="btn" onclick="game.cheat('talents')" style="width: 100%; margin: 5px 0;">üåü +10 Talent Points</button>
                    <button class="btn" onclick="game.cheat('floor')" style="width: 100%; margin: 5px 0;">‚¨ÜÔ∏è +10 Floors</button>
                    <button class="btn" onclick="game.cheat('godmode')" style="width: 100%; margin: 5px 0;">üõ°Ô∏è Toggle God Mode</button>
                    <button class="btn" onclick="game.cheat('killEnemy')" style="width: 100%; margin: 5px 0; background: #ff4b2b;">üíÄ Instant Kill Enemy</button>
                    <button class="btn" onclick="game.cheat('allPets')" style="width: 100%; margin: 5px 0;">üêæ Unlock All Pets</button>
                    <button class="btn" onclick="game.cheat('legendary')" style="width: 100%; margin: 5px 0;">‚ú® Get Legendary Item</button>
                    <button class="btn" onclick="game.cheat('maxStats')" style="width: 100%; margin: 5px 0; background: #ffd700;">‚ö° Max Stats</button>
                </div>
            </div>
            <button class="btn" onclick="game.closeCheats()">Close</button>
        </div>
    </div>

    <script>
        var CLASSES = {
            warrior: { name: 'Warrior', icon: '‚öîÔ∏è', desc: 'Balanced fighter', bonuses: { hp: 20, attack: 5, defense: 3 } },
            mage: { name: 'Mage', icon: 'üîÆ', desc: 'Glass cannon', bonuses: { hp: -10, attack: 8, defense: 0 } },
            rogue: { name: 'Rogue', icon: 'üó°Ô∏è', desc: 'High crit', bonuses: { hp: 0, attack: 3, defense: 2 } },
            paladin: { name: 'Paladin', icon: 'üõ°Ô∏è', desc: 'Holy healer', bonuses: { hp: 30, attack: 4, defense: 6 } },
            necromancer: { name: 'Necromancer', icon: 'üíÄ', desc: 'Lifesteal', bonuses: { hp: 10, attack: 6, defense: 3 } },
            dragonborn: { name: 'Dragonborn', icon: 'üêâ', desc: 'Legendary', bonuses: { hp: 50, attack: 10, defense: 8 } }
        };

        var ENEMIES = [
            { name: 'Goblin', icon: 'üëπ', hp: 50, attack: 8, defense: 2, gold: 10, xp: 20 },
            { name: 'Orc', icon: 'üë∫', hp: 80, attack: 12, defense: 5, gold: 15, xp: 30 },
            { name: 'Troll', icon: 'üßü', hp: 120, attack: 14, defense: 8, gold: 25, xp: 50 },
            { name: 'Dragon', icon: 'üê≤', hp: 200, attack: 20, defense: 12, gold: 50, xp: 100 }
        ];

        var TALENTS = [
            { id: 'power1', name: 'Power I', desc: '+5 Attack', cost: 1, bonus: { attack: 5 }, requires: null },
            { id: 'power2', name: 'Power II', desc: '+10 Attack', cost: 1, bonus: { attack: 10 }, requires: 'power1' },
            { id: 'power3', name: 'Power III', desc: '+15 Attack', cost: 1, bonus: { attack: 15 }, requires: 'power2' },
            { id: 'defense1', name: 'Iron Skin I', desc: '+3 Defense', cost: 1, bonus: { defense: 3 }, requires: null },
            { id: 'defense2', name: 'Iron Skin II', desc: '+6 Defense', cost: 1, bonus: { defense: 6 }, requires: 'defense1' },
            { id: 'defense3', name: 'Iron Skin III', desc: '+10 Defense', cost: 1, bonus: { defense: 10 }, requires: 'defense2' },
            { id: 'vitality1', name: 'Vitality I', desc: '+30 HP', cost: 1, bonus: { hp: 30 }, requires: null },
            { id: 'vitality2', name: 'Vitality II', desc: '+50 HP', cost: 1, bonus: { hp: 50 }, requires: 'vitality1' },
            { id: 'vitality3', name: 'Vitality III', desc: '+80 HP', cost: 1, bonus: { hp: 80 }, requires: 'vitality2' }
        ];

        var PETS = [
            { id: 'wolf', name: 'Wolf', icon: 'üê∫', desc: '+5 Attack bonus', bonus: { attack: 5 }, cost: 100 },
            { id: 'bear', name: 'Bear', icon: 'üêª', desc: '+5 Defense bonus', bonus: { defense: 5 }, cost: 150 },
            { id: 'phoenix', name: 'Phoenix', icon: 'üî•', desc: 'Revive once per floor', bonus: { hp: 20 }, cost: 300, special: 'revive' },
            { id: 'dragon', name: 'Baby Dragon', icon: 'ü¶é', desc: 'All stats +3', bonus: { attack: 3, defense: 3, hp: 30 }, cost: 500 }
        ];

        function Game() {
            this.player = null;
            this.enemy = null;
            this.floor = 1;
            this.talentPoints = 0;
            this.unlockedTalents = [];
            this.activePet = null;
            this.ownedPets = [];
            this.cheatsUnlocked = false;
            this.godMode = false;
        }

        Game.prototype.init = function() {
            var container = document.getElementById('classSelection');
            for (var key in CLASSES) {
                var cls = CLASSES[key];
                var card = document.createElement('div');
                card.className = 'class-card';
                card.innerHTML = '<div class="class-icon">' + cls.icon + '</div>' +
                    '<div style="font-size: 1.3em; color: #ffd700; margin: 10px 0;">' + cls.name + '</div>' +
                    '<div style="color: #aaa; margin-bottom: 10px;">' + cls.desc + '</div>' +
                    '<div style="font-size: 0.9em;">HP: ' + (cls.bonuses.hp > 0 ? '+' : '') + cls.bonuses.hp + '<br>' +
                    'ATK: +' + cls.bonuses.attack + '<br>DEF: +' + cls.bonuses.defense + '</div>';
                card.setAttribute('data-class', key);
                var self = this;
                card.onclick = function() { self.selectClass(this.getAttribute('data-class')); };
                container.appendChild(card);
            }
        };

        Game.prototype.selectClass = function(classKey) {
            var cls = CLASSES[classKey];
            this.player = {
                classKey: classKey,
                name: cls.name,
                icon: cls.icon,
                level: 1,
                xp: 0,
                xpToLevel: 100,
                maxHp: 100 + cls.bonuses.hp,
                hp: 100 + cls.bonuses.hp,
                attack: 10 + cls.bonuses.attack,
                defense: 5 + cls.bonuses.defense,
                gold: 0,
                inventory: []
            };

            document.getElementById('classSelectionScreen').style.display = 'none';
            document.getElementById('gameArea').style.display = 'grid';
            this.spawnEnemy();
            this.updateUI();
            this.log('Welcome! Begin your climb!');
        };

        Game.prototype.playerAttack = function() {
            if (!this.enemy || this.enemy.hp <= 0) return;
            
            var damage = this.player.attack;
            
            if (this.activePet && this.activePet.bonus.attack) {
                damage += this.activePet.bonus.attack;
            }
            
            damage = Math.max(1, damage - this.enemy.defense);
            this.enemy.hp -= damage;
            this.log('You attack for ' + damage + ' damage!');
            
            if (this.activePet) {
                var petDamage = Math.floor(damage * 0.2);
                this.enemy.hp -= petDamage;
                this.log(this.activePet.name + ' deals ' + petDamage + ' damage!');
            }
            
            if (this.enemy.hp <= 0) {
                this.enemyDefeated();
            } else {
                var self = this;
                setTimeout(function() { self.enemyAttack(); }, 500);
            }
            this.updateUI();
        };

        Game.prototype.playerDefend = function() {
            this.log('You defend!');
            var self = this;
            setTimeout(function() { self.enemyAttack(); }, 500);
        };

        Game.prototype.useAbility = function() {
            var damage = Math.floor(this.player.attack * 2);
            this.enemy.hp -= damage;
            this.log('Ability! ' + damage + ' damage!');
            
            if (this.enemy.hp <= 0) {
                this.enemyDefeated();
            } else {
                var self = this;
                setTimeout(function() { self.enemyAttack(); }, 500);
            }
            this.updateUI();
        };

        Game.prototype.enemyAttack = function() {
            if (!this.enemy || this.enemy.hp <= 0) return;
            
            if (this.godMode) {
                this.log('God Mode: No damage taken!');
                this.updateUI();
                return;
            }
            
            var defense = this.player.defense;
            
            if (this.activePet && this.activePet.bonus.defense) {
                defense += this.activePet.bonus.defense;
            }
            
            var damage = Math.max(1, this.enemy.attack - defense);
            this.player.hp -= damage;
            this.log(this.enemy.name + ' attacks for ' + damage + '!');
            
            if (this.player.hp <= 0) {
                if (this.activePet && this.activePet.special === 'revive' && !this.activePet.reviveUsed) {
                    this.player.hp = Math.floor(this.player.maxHp * 0.5);
                    this.activePet.reviveUsed = true;
                    this.log('Phoenix revives you with 50% HP!');
                } else {
                    this.log('Defeated! Restarting...');
                    this.floor = 1;
                    this.player.hp = this.player.maxHp;
                    if (this.activePet && this.activePet.reviveUsed) {
                        this.activePet.reviveUsed = false;
                    }
                    this.spawnEnemy();
                }
            }
            this.updateUI();
        };

        Game.prototype.enemyDefeated = function() {
            this.player.gold += this.enemy.gold;
            this.player.xp += this.enemy.xp;
            this.log('Victory! +' + this.enemy.gold + ' gold, +' + this.enemy.xp + ' XP');
            
            if (this.activePet && this.activePet.reviveUsed) {
                this.activePet.reviveUsed = false;
            }
            
            if (Math.random() < 0.4) {
                var item = this.generateItem();
                this.player.inventory.push(item);
                this.log('Found: ' + item.name + '!');
            }
            
            while (this.player.xp >= this.player.xpToLevel) {
                this.levelUp();
            }
            
            document.getElementById('proceedBtn').style.display = 'block';
            this.updateUI();
        };

        Game.prototype.levelUp = function() {
            this.player.xp -= this.player.xpToLevel;
            this.player.level++;
            this.player.maxHp += 20;
            this.player.hp = this.player.maxHp;
            this.player.attack += 2;
            this.player.defense += 2;
            this.player.xpToLevel = Math.floor(this.player.xpToLevel * 1.2);
            this.talentPoints++;
            this.log('Level Up! Now level ' + this.player.level + '! +1 Talent Point');
        };

        Game.prototype.nextFloor = function() {
            this.floor++;
            this.spawnEnemy();
            document.getElementById('proceedBtn').style.display = 'none';
            this.updateUI();
        };

        Game.prototype.spawnEnemy = function() {
            var template = ENEMIES[Math.min(Math.floor(this.floor / 5), ENEMIES.length - 1)];
            var scaling = Math.pow(1.15, this.floor - 1);
            
            this.enemy = {
                name: template.name,
                icon: template.icon,
                maxHp: Math.floor(template.hp * scaling),
                hp: Math.floor(template.hp * scaling),
                attack: Math.floor(template.attack * scaling),
                defense: Math.floor(template.defense * scaling),
                gold: Math.floor(template.gold * scaling),
                xp: Math.floor(template.xp * scaling)
            };
            
            this.log(this.enemy.name + ' appears!');
            this.updateUI();
        };

        Game.prototype.generateItem = function() {
            var types = ['weapon', 'armor'];
            var type = types[Math.floor(Math.random() * types.length)];
            var rarities = ['common', 'uncommon', 'rare', 'epic', 'legendary'];
            var rarity = rarities[Math.min(Math.floor(Math.random() * 3), 4)];
            var rarityMult = { common: 1, uncommon: 1.5, rare: 2, epic: 3, legendary: 5 }[rarity];
            
            var itemNames = {
                weapon: ['Iron Sword', 'Steel Blade', 'Magic Staff', 'Dragon Slayer'],
                armor: ['Leather Armor', 'Chain Mail', 'Plate Armor', 'Dragon Scale']
            };
            
            var floorBonus = Math.floor(this.floor / 5);
            var item = {
                id: Date.now() + Math.random(),
                name: itemNames[type][Math.floor(Math.random() * itemNames[type].length)],
                type: type,
                rarity: rarity
            };
            
            if (type === 'weapon') {
                item.attack = Math.floor((5 + floorBonus) * rarityMult);
            } else {
                item.defense = Math.floor((3 + floorBonus) * rarityMult);
                item.hp = Math.floor((10 + floorBonus * 5) * rarityMult);
            }
            
            return item;
        };

        Game.prototype.openShop = function() {
            var modal = document.getElementById('shopModal');
            var shopItems = document.getElementById('shopItems');
            shopItems.innerHTML = '';
            
            for (var i = 0; i < 6; i++) {
                var item = this.generateItem();
                var price = Math.floor(50 + this.floor * 10);
                
                var itemDiv = document.createElement('div');
                itemDiv.style.cssText = 'background: #0f3460; padding: 15px; margin: 10px 0; border-radius: 5px; display: flex; justify-content: space-between;';
                itemDiv.innerHTML = '<div><div class="rarity-' + item.rarity + '" style="font-weight: bold;">' + item.name + '</div>' +
                    '<div style="font-size: 0.9em; color: #aaa;">' + 
                    (item.attack ? 'ATK: +' + item.attack + '<br>' : '') +
                    (item.defense ? 'DEF: +' + item.defense + '<br>' : '') +
                    (item.hp ? 'HP: +' + item.hp : '') + '</div></div>' +
                    '<div><div style="color: #ffd700;">üí∞ ' + price + '</div>' +
                    '<button class="btn" onclick="game.buyItem(' + i + ')">Buy</button></div>';
                itemDiv.setAttribute('data-item', JSON.stringify({ item: item, price: price }));
                shopItems.appendChild(itemDiv);
            }
            
            modal.classList.add('show');
        };

        Game.prototype.buyItem = function(index) {
            var shopItems = document.getElementById('shopItems');
            var itemDiv = shopItems.children[index];
            var data = JSON.parse(itemDiv.getAttribute('data-item'));
            
            if (this.player.gold >= data.price) {
                this.player.gold -= data.price;
                this.player.inventory.push(data.item);
                this.log('Purchased ' + data.item.name + '!');
                this.closeShop();
                this.updateUI();
            } else {
                this.log('Not enough gold!');
            }
        };

        Game.prototype.closeShop = function() {
            document.getElementById('shopModal').classList.remove('show');
        };

        Game.prototype.openTalents = function() {
            var modal = document.getElementById('talentModal');
            var tree = document.getElementById('talentTree');
            tree.innerHTML = '';
            
            document.getElementById('availablePoints').textContent = this.talentPoints;
            
            for (var i = 0; i < TALENTS.length; i++) {
                var talent = TALENTS[i];
                var unlocked = this.unlockedTalents.indexOf(talent.id) !== -1;
                var canUnlock = !unlocked && this.talentPoints > 0 && 
                    (!talent.requires || this.unlockedTalents.indexOf(talent.requires) !== -1);
                
                var node = document.createElement('div');
                node.className = 'talent-node ' + (unlocked ? 'unlocked' : canUnlock ? '' : 'locked');
                node.innerHTML = '<div style="font-size: 1.5em; margin-bottom: 10px;">' + (unlocked ? '‚úÖ' : 'üîí') + '</div>' +
                    '<div style="font-weight: bold; margin-bottom: 5px;">' + talent.name + '</div>' +
                    '<div style="font-size: 0.85em; color: #aaa; margin-bottom: 5px;">' + talent.desc + '</div>' +
                    '<div style="color: #ffd700;">Cost: ' + talent.cost + ' pt</div>';
                
                if (canUnlock) {
                    node.setAttribute('data-talent-id', talent.id);
                    var self = this;
                    node.onclick = function() {
                        self.unlockTalent(this.getAttribute('data-talent-id'));
                    };
                }
                
                tree.appendChild(node);
            }
            
            modal.classList.add('show');
        };

        Game.prototype.unlockTalent = function(talentId) {
            var talent = null;
            for (var i = 0; i < TALENTS.length; i++) {
                if (TALENTS[i].id === talentId) {
                    talent = TALENTS[i];
                    break;
                }
            }
            
            if (!talent || this.talentPoints < talent.cost) return;
            
            this.talentPoints -= talent.cost;
            this.unlockedTalents.push(talentId);
            
            if (talent.bonus.attack) {
                this.player.attack += talent.bonus.attack;
            }
            if (talent.bonus.defense) {
                this.player.defense += talent.bonus.defense;
            }
            if (talent.bonus.hp) {
                this.player.maxHp += talent.bonus.hp;
                this.player.hp += talent.bonus.hp;
            }
            
            this.log('Unlocked: ' + talent.name + '!');
            this.openTalents();
            this.updateUI();
        };

        Game.prototype.closeTalents = function() {
            document.getElementById('talentModal').classList.remove('show');
        };

        Game.prototype.openPets = function() {
            var modal = document.getElementById('petModal');
            var list = document.getElementById('petList');
            list.innerHTML = '';
            
            for (var i = 0; i < PETS.length; i++) {
                var pet = PETS[i];
                var owned = false;
                var ownedPet = null;
                for (var j = 0; j < this.ownedPets.length; j++) {
                    if (this.ownedPets[j].id === pet.id) {
                        owned = true;
                        ownedPet = this.ownedPets[j];
                        break;
                    }
                }
                
                var canBuy = !owned && this.player.gold >= pet.cost;
                var isActive = this.activePet && this.activePet.id === pet.id;
                
                var card = document.createElement('div');
                card.className = 'pet-card' + (isActive ? ' active' : '');
                card.innerHTML = '<div><div style="font-size: 2em;">' + pet.icon + '</div></div>' +
                    '<div style="flex: 1; margin: 0 15px;">' +
                    '<div style="font-weight: bold; color: #ffd700; margin-bottom: 5px;">' + pet.name + '</div>' +
                    '<div style="font-size: 0.85em; color: #aaa; margin-bottom: 5px;">' + pet.desc + '</div>' +
                    '<div style="font-size: 0.85em;">' +
                    (pet.bonus.attack ? 'ATK: +' + pet.bonus.attack + ' ' : '') +
                    (pet.bonus.defense ? 'DEF: +' + pet.bonus.defense + ' ' : '') +
                    (pet.bonus.hp ? 'HP: +' + pet.bonus.hp : '') + '</div>' +
                    (!owned ? '<div style="color: #ffd700; margin-top: 5px;">Cost: ' + pet.cost + ' gold</div>' : '') +
                    '</div><div>';
                
                if (owned) {
                    card.innerHTML += '<button class="btn" onclick="game.activatePet(\'' + pet.id + '\')">' + (isActive ? 'Active' : 'Activate') + '</button>';
                } else {
                    card.innerHTML += '<button class="btn" ' + (!canBuy ? 'disabled' : '') + ' onclick="game.buyPet(\'' + pet.id + '\')">Buy</button>';
                }
                
                card.innerHTML += '</div>';
                list.appendChild(card);
            }
            
            modal.classList.add('show');
        };

        Game.prototype.buyPet = function(petId) {
            var pet = null;
            for (var i = 0; i < PETS.length; i++) {
                if (PETS[i].id === petId) {
                    pet = PETS[i];
                    break;
                }
            }
            
            if (!pet || this.player.gold < pet.cost) return;
            
            this.player.gold -= pet.cost;
            var newPet = {
                id: pet.id,
                name: pet.name,
                icon: pet.icon,
                desc: pet.desc,
                bonus: pet.bonus,
                special: pet.special,
                reviveUsed: false
            };
            this.ownedPets.push(newPet);
            this.log('Purchased ' + pet.name + '!');
            this.openPets();
            this.updateUI();
        };

        Game.prototype.activatePet = function(petId) {
            var pet = null;
            for (var i = 0; i < this.ownedPets.length; i++) {
                if (this.ownedPets[i].id === petId) {
                    pet = this.ownedPets[i];
                    break;
                }
            }
            
            if (!pet) return;
            
            this.activePet = pet;
            this.log(pet.name + ' is now active!');
            document.getElementById('petModal').classList.remove('show');
            this.updateUI();
        };

        Game.prototype.closePets = function() {
            document.getElementById('petModal').classList.remove('show');
        };

        Game.prototype.openCheats = function() {
            document.getElementById('cheatModal').classList.add('show');
            if (this.cheatsUnlocked) {
                document.getElementById('cheatButtons').style.display = 'block';
            }
        };

        Game.prototype.unlockCheats = function() {
            var password = document.getElementById('cheatPassword').value;
            if (password === 'tower123' || password === 'dev' || password === 'admin') {
                this.cheatsUnlocked = true;
                document.getElementById('cheatButtons').style.display = 'block';
                this.log('Debug mode unlocked!');
            } else {
                alert('Incorrect password! Try: tower123');
            }
        };

        Game.prototype.cheat = function(type) {
            if (!this.cheatsUnlocked) return;
            
            switch(type) {
                case 'gold':
                    this.player.gold += 10000;
                    this.log('CHEAT: +10000 gold');
                    break;
                case 'xp':
                    this.player.xp += 5000;
                    while (this.player.xp >= this.player.xpToLevel) {
                        this.levelUp();
                    }
                    this.log('CHEAT: +5000 XP');
                    break;
                case 'level':
                    for (var i = 0; i < 10; i++) {
                        this.player.level++;
                        this.player.maxHp += 20;
                        this.player.hp = this.player.maxHp;
                        this.player.attack += 2;
                        this.player.defense += 2;
                        this.talentPoints++;
                    }
                    this.log('CHEAT: +10 levels');
                    break;
                case 'talents':
                    this.talentPoints += 10;
                    this.log('CHEAT: +10 talent points');
                    break;
                case 'floor':
                    this.floor += 10;
                    this.spawnEnemy();
                    this.log('CHEAT: +10 floors');
                    break;
                case 'godmode':
                    this.godMode = !this.godMode;
                    this.log('CHEAT: God Mode ' + (this.godMode ? 'ON' : 'OFF'));
                    break;
                case 'killEnemy':
                    if (this.enemy) {
                        this.enemy.hp = 0;
                        this.enemyDefeated();
                        this.log('CHEAT: Enemy killed');
                    }
                    break;
                case 'allPets':
                    for (var i = 0; i < PETS.length; i++) {
                        var pet = PETS[i];
                        var exists = false;
                        for (var j = 0; j < this.ownedPets.length; j++) {
                            if (this.ownedPets[j].id === pet.id) {
                                exists = true;
                                break;
                            }
                        }
                        if (!exists) {
                            this.ownedPets.push({
                                id: pet.id,
                                name: pet.name,
                                icon: pet.icon,
                                desc: pet.desc,
                                bonus: pet.bonus,
                                special: pet.special,
                                reviveUsed: false
                            });
                        }
                    }
                    this.log('CHEAT: All pets unlocked');
                    break;
                case 'legendary':
                    var item = this.generateItem();
                    item.rarity = 'legendary';
                    item.attack = item.attack ? item.attack * 5 : undefined;
                    item.defense = item.defense ? item.defense * 5 : undefined;
                    item.hp = item.hp ? item.hp * 5 : undefined;
                    this.player.inventory.push(item);
                    this.log('CHEAT: Legendary item added');
                    break;
                case 'maxStats':
                    this.player.attack += 100;
                    this.player.defense += 100;
                    this.player.maxHp += 1000;
                    this.player.hp = this.player.maxHp;
                    this.log('CHEAT: Max stats applied');
                    break;
            }
            
            this.updateUI();
        };

        Game.prototype.closeCheats = function() {
            document.getElementById('cheatModal').classList.remove('show');
        };

        Game.prototype.equipItem = function(index) {
            var item = this.player.inventory[index];
            if (!item) return;
            
            if (item.type === 'weapon') {
                this.player.attack += item.attack;
            } else if (item.type === 'armor') {
                this.player.defense += item.defense;
                this.player.maxHp += item.hp;
                this.player.hp += item.hp;
            }
            
            this.log('Equipped ' + item.name + '!');
            this.player.inventory.splice(index, 1);
            this.updateUI();
        };

        Game.prototype.saveGame = function() {
            localStorage.setItem('towerSave', JSON.stringify({ 
                player: this.player, 
                floor: this.floor,
                talentPoints: this.talentPoints,
                unlockedTalents: this.unlockedTalents,
                activePet: this.activePet,
                ownedPets: this.ownedPets
            }));
            this.log('Game saved!');
        };

        Game.prototype.loadGame = function() {
            var data = localStorage.getItem('towerSave');
            if (data) {
                var save = JSON.parse(data);
                this.player = save.player;
                this.floor = save.floor;
                this.talentPoints = save.talentPoints || 0;
                this.unlockedTalents = save.unlockedTalents || [];
                this.activePet = save.activePet || null;
                this.ownedPets = save.ownedPets || [];
                document.getElementById('classSelectionScreen').style.display = 'none';
                document.getElementById('gameArea').style.display = 'grid';
                this.spawnEnemy();
                this.updateUI();
                this.log('Game loaded!');
            }
        };

        Game.prototype.updateUI = function() {
            if (!this.player) return;
            
            document.getElementById('className').textContent = this.player.name;
            document.getElementById('charLevel').textContent = this.player.level;
            document.getElementById('talentPoints').textContent = this.talentPoints;
            document.getElementById('charHP').textContent = this.player.hp + '/' + this.player.maxHp;
            document.getElementById('charXP').textContent = this.player.xp + '/' + this.player.xpToLevel;
            document.getElementById('charAttack').textContent = this.player.attack;
            document.getElementById('charDefense').textContent = this.player.defense;
            document.getElementById('charGold').textContent = 'üí∞ ' + this.player.gold;
            
            var hpPercent = (this.player.hp / this.player.maxHp) * 100;
            document.getElementById('hpBar').style.width = hpPercent + '%';
            
            var xpPercent = (this.player.xp / this.player.xpToLevel) * 100;
            document.getElementById('xpBar').style.width = xpPercent + '%';
            
            document.getElementById('floorNumber').textContent = this.floor;
            document.getElementById('playerSprite').textContent = this.player.icon;
            
            if (this.activePet) {
                document.getElementById('petSprite').textContent = this.activePet.icon;
                document.getElementById('activePet').innerHTML = 
                    '<div style="font-size: 2em; margin-bottom: 10px;">' + this.activePet.icon + '</div>' +
                    '<div style="font-weight: bold; color: #ffd700;">' + this.activePet.name + '</div>' +
                    '<div style="font-size: 0.9em; color: #aaa; margin-top: 5px;">' + this.activePet.desc + '</div>';
            } else {
                document.getElementById('petSprite').textContent = '';
                document.getElementById('activePet').innerHTML = '<div style="color: #aaa;">No pet active</div>';
            }
            
            if (this.enemy) {
                document.getElementById('enemySprite').textContent = this.enemy.icon;
                document.getElementById('enemyName').textContent = this.enemy.name;
                document.getElementById('enemyHP').textContent = 'HP: ' + Math.max(0, this.enemy.hp) + '/' + this.enemy.maxHp;
            }
            
            this.updateInventoryUI();
        };

        Game.prototype.updateInventoryUI = function() {
            var invGrid = document.getElementById('inventoryGrid');
            invGrid.innerHTML = '';
            
            for (var i = 0; i < this.player.inventory.length; i++) {
                var item = this.player.inventory[i];
                var itemDiv = document.createElement('div');
                itemDiv.className = 'item-slot';
                itemDiv.innerHTML = '<div class="rarity-' + item.rarity + '" style="font-weight: bold;">' + item.name + '</div>' +
                    '<div style="font-size: 0.85em; color: #aaa;">' +
                    (item.attack ? 'ATK: +' + item.attack + '<br>' : '') +
                    (item.defense ? 'DEF: +' + item.defense + '<br>' : '') +
                    (item.hp ? 'HP: +' + item.hp + '<br>' : '') +
                    item.rarity.toUpperCase() + '</div>' +
                    '<button class="btn" style="padding: 5px; font-size: 0.8em; width: 100%; margin-top: 5px;" onclick="game.equipItem(' + i + ')">Equip</button>';
                invGrid.appendChild(itemDiv);
            }
            
            if (this.player.inventory.length === 0) {
                invGrid.innerHTML = '<div style="color: #aaa; text-align: center; padding: 20px;">Empty</div>';
            }
        };

        Game.prototype.log = function(message) {
            var log = document.getElementById('eventLog');
            var entry = document.createElement('div');
            entry.textContent = '> ' + message;
            entry.style.borderBottom = '1px solid #1a1a2e';
            entry.style.padding = '5px 0';
            log.insertBefore(entry, log.firstChild);
            while (log.children.length > 10) {
                log.removeChild(log.lastChild);
            }
        };

        var game = new Game();
        window.onload = function() {
            game.init();
        };
    </script>
</body>
</html>
